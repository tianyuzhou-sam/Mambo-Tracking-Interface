# Mambo-Tracking-Interface

This is the Python interface for RTD and the Parrot [Mambo](https://www.parrot.com/us/drones/parrot-mambo-fpv) Quadrotor.


# Dependencies

This repo has been tested with:
* Ubuntu 18.04.4 LTS, Python 3.6.9.

You can use the latest version of Python 3 and dependencies. Here is the list of all dependencies this repository uses:
```
Python>=3.6.9
numpy
scipy
transforms3d
matplotlib
pyparrot
qtm  # for motion capture system Qualisys
owl==5.1.279  # for motion capture system PhaseSpace, you can't download this by pip
```

Use [pip](https://pip.pypa.io/en/stable/) to install the required packages:
```
$ sudo pip3 install numpy scipy transforms3d matplotlib
$ git clone https://github.com/zehuilu/Mambo-Tracking-Interface.git
```

To install [pyparrot](https://github.com/amymcgovern/pyparrot), you can follow the official documentation [website](https://pyparrot.readthedocs.io/en/latest/installation.html).

This repository supports [PhaseSpace](https://www.phasespace.com/) Motion Capture System for the state estimation. Since we are unable to distribute its Python API `owl.py` here, you have to manually copy `owl.py` to `<MAIN_DIRECTORY>/lib`.

This repository supports [Qualisys](https://www.qualisys.com/) Motion Capture System for the state estimation.
To install [Qualisys Python SDK](https://github.com/qualisys/qualisys_python_sdk),
```
$ sudo pip3 install qtm
```

Feel free to change the state estimation function to use your own motion capture system.


# Path Configuration

Assume you are currently under the main directory of this repository, then create two directories by
```
$ cd <MAIN_DIRECTORY>
$ mkdir traj_csv_files
$ mkdir sysid_data
```

This directory `/traj_csv_files` stores the desired trajectories csv files generated by a motion planner (eg., quadrotor_RTD in 2 Hz), and the low-level controller reads the latest csv file as the desired trajectory in 10 Hz. When the interface is initializing, it will delete all existing files in `/traj_csv_files` such that there are only trajectories files under this trajectory when the controller is running.


# Communication with PhaseSpace and MATLAB RTD

This project uses mocap for absolute positions and attitudes. Between mocap and LLC (Low-Level Controller, i.e LLC.py), the communication is via TCP/IP. You need to start mocap first, and then run LLC. If the drone is flying outside the mocap region, you can’t get any new data in TCP/IP and all the scripts will wait for new data. So the callback function get_states_mocap() in helper_function.py will land the drone immediately for the safety. The default host and port are ‘127.0.0.1’ (equivalent to ‘localhost’) and 9000. The communication between MATLAB and LLC is via UDP. LLC provides the positions and velocities of the drone to MATLAB. The default host and port are ‘127.0.0.1’ (equivalent to ‘localhost’) and 11000.

Sometimes you may want to shut down the current mocap.py and LLC.py and rerun them, but you may get errors like “The current port is occupied.” You can either wait for a few minutes or change the port value accordingly. But do not mess up with the different ports.





# How to run this interface

1. Run the motion capture system PhaseSpace by
```
cd <MAIN_DIRECTORY>
python3 src/run_mocap_phasespace.py
```

Or run the motion capture system Qualisys by
```
cd <MAIN_DIRECTORY>
python3 src/run_mocap_qualisys.py
```


2. Run the Mambo controller
```
cd <MAIN_DIRECTORY>
python3 src/run_mambo.py
```


3. Run [RTD](https://asmedigitalcollection.asme.org/DSCC/proceedings/DSCC2019/59162/V003T19A010/1070634) (Reachability-based Trajectory Design) as the motion planner.

Follow step 1 and 2 of this section. After you see the reminder message in Mambo controller, run the quadrotor_RTD planner via MATLAB.

